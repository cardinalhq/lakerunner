-- 1756598351_metric_rollup_queue.up.sql

-- Code generated by database migration. DO NOT EDIT.

-- ===== Metric rollup work queue table =====
CREATE TABLE IF NOT EXISTS metric_rollup_queue (
  id              BIGSERIAL   PRIMARY KEY,
  queue_ts        TIMESTAMPTZ NOT NULL DEFAULT now(),
  priority        INTEGER     NOT NULL DEFAULT 0,
  organization_id UUID        NOT NULL,
  dateint         INTEGER     NOT NULL,
  frequency_ms    BIGINT      NOT NULL,
  instance_num    SMALLINT    NOT NULL,
  slot_id         INTEGER     NOT NULL,
  slot_count      INTEGER     NOT NULL,
  ts_range        TSTZRANGE   NOT NULL,
  tries           INTEGER     NOT NULL DEFAULT 0,
  claimed_by      BIGINT      NOT NULL DEFAULT -1,
  claimed_at      TIMESTAMPTZ,
  heartbeated_at  TIMESTAMPTZ
);

-- Global ready ordering (ranking / tie-break friendly)
CREATE INDEX IF NOT EXISTS idx_mrq_ready_global
ON metric_rollup_queue (priority DESC, queue_ts, id)
WHERE claimed_at IS NULL;

-- Per-group ordered slice (including slot_id and slot_count)
CREATE INDEX IF NOT EXISTS idx_mrq_ready_group
ON metric_rollup_queue (
  organization_id, dateint, frequency_ms, instance_num, slot_id, slot_count,
  priority DESC, queue_ts, id
)
WHERE claimed_at IS NULL;

-- Timeout sweeper
CREATE INDEX IF NOT EXISTS idx_mrq_claimed_at_nonnull
ON metric_rollup_queue (claimed_at)
WHERE claimed_at IS NOT NULL;