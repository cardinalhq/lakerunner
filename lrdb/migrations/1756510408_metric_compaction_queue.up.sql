-- 1756510408_metric_compaction_queue.up.sql

-- Code generated by database migration. DO NOT EDIT.


CREATE TABLE IF NOT EXISTS metric_compaction_queue (
  id              BIGSERIAL   PRIMARY KEY,
  queue_ts        TIMESTAMPTZ NOT NULL DEFAULT now(),
  priority        INTEGER     NOT NULL DEFAULT 0,
  organization_id UUID        NOT NULL,
  dateint         INTEGER     NOT NULL,
  frequency_ms    BIGINT      NOT NULL,
  segment_id      UUID        NOT NULL,
  instance_num    SMALLINT    NOT NULL,
  ts_range        TSTZRANGE   NOT NULL,
  record_count    BIGINT      NOT NULL,
  tries           INTEGER     NOT NULL DEFAULT 0,
  claimed_by      BIGINT      NOT NULL DEFAULT -1,
  claimed_at      TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_metric_compaction_queue_pri_ts ON metric_compaction_queue (priority, queue_ts);

CREATE INDEX IF NOT EXISTS idx_metric_compaction_queue_ready ON metric_compaction_queue (priority DESC, queue_ts) WHERE claimed_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_metric_compaction_queue_claimed_at_nonnull ON metric_compaction_queue (claimed_at) WHERE claimed_at IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_metric_compaction_queue_org_dateint ON metric_compaction_queue (organization_id, dateint);

