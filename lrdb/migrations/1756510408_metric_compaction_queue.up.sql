-- 1756510408_metric_compaction_queue.up.sql

-- Code generated by database migration. DO NOT EDIT.


CREATE TABLE IF NOT EXISTS metric_compaction_queue (
  id              BIGSERIAL   PRIMARY KEY,
  queue_ts        TIMESTAMPTZ NOT NULL DEFAULT now(),
  priority        INTEGER     NOT NULL DEFAULT 0,
  organization_id UUID        NOT NULL,
  dateint         INTEGER     NOT NULL,
  frequency_ms    BIGINT      NOT NULL,
  segment_id      UUID        NOT NULL,
  instance_num    SMALLINT    NOT NULL,
  ts_range        TSTZRANGE   NOT NULL,
  record_count    BIGINT      NOT NULL,
  tries           INTEGER     NOT NULL DEFAULT 0,
  claimed_by      BIGINT      NOT NULL DEFAULT -1,
  claimed_at      TIMESTAMPTZ
);

-- Global ready ordering for picking groups quickly
CREATE INDEX IF NOT EXISTS idx_mcq_ready_global
ON metric_compaction_queue (priority DESC, queue_ts)
WHERE claimed_at IS NULL;

-- Fast per-group scans once a group is considered
CREATE INDEX IF NOT EXISTS idx_mcq_ready_group
ON metric_compaction_queue (organization_id, instance_num, dateint, priority DESC, queue_ts)
WHERE claimed_at IS NULL;

-- timeout sweeper
CREATE INDEX IF NOT EXISTS idx_mcq_claimed_at_nonnull
ON metric_compaction_queue (claimed_at)
WHERE claimed_at IS NOT NULL;
