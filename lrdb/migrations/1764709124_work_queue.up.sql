-- 1764709124_work_queue.up.sql

-- Code generated by database migration. DO NOT EDIT.


-- Work queue table: one row per work item
CREATE TABLE work_queue (
  id              BIGSERIAL       PRIMARY KEY,
  task_name       TEXT            NOT NULL,
  organization_id UUID            NOT NULL,
  instance_num    SMALLINT        NOT NULL,
  spec            JSONB           NOT NULL,
  tries           INTEGER         NOT NULL DEFAULT 0,
  claimed_by      BIGINT          NOT NULL DEFAULT -1,
  claimed_at      TIMESTAMPTZ,
  heartbeated_at  TIMESTAMPTZ,
  failed          BOOLEAN         NOT NULL DEFAULT false,
  failed_reason   TEXT,
  created_at      TIMESTAMPTZ     NOT NULL DEFAULT NOW()
);

-- Primary claiming index: workers find their work by task_name
-- Exclude permanently failed items (those with failed = true)
CREATE INDEX idx_work_queue_claim
  ON work_queue (task_name, id)
  WHERE claimed_by = -1 AND failed = false;

-- Heartbeat expiration index: find dead workers
CREATE INDEX idx_work_queue_heartbeat_expiry
  ON work_queue (heartbeated_at)
  INCLUDE (id, claimed_by)
  WHERE claimed_by <> -1;

-- Monitoring: queue depth by task_name
CREATE INDEX idx_work_queue_monitoring
  ON work_queue (task_name);

-- Autovacuum settings and fillfactor for hot table
ALTER TABLE work_queue
  SET (autovacuum_vacuum_scale_factor = 0.02,
       autovacuum_analyze_scale_factor = 0.02,
       autovacuum_vacuum_threshold = 1000,
       autovacuum_analyze_threshold = 1000,
       fillfactor = 80);
