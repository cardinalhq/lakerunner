-- 1757509449_add_signal_to_pack_estimator.up.sql

-- Code generated by database migration. DO NOT EDIT.

ALTER TABLE metric_pack_estimate ADD COLUMN signal TEXT NOT NULL DEFAULT 'metrics';

ALTER TABLE metric_pack_estimate DROP CONSTRAINT metric_pack_estimate_pkey;

ALTER TABLE metric_pack_estimate ADD PRIMARY KEY (signal, organization_id, frequency_ms);

DROP INDEX IF EXISTS idx_mpe_freq_global;
CREATE INDEX IF NOT EXISTS idx_mpe_freq_signal_global
  ON metric_pack_estimate (frequency_ms, signal)
  WHERE organization_id = '00000000-0000-0000-0000-000000000000'::uuid;

INSERT INTO metric_pack_estimate (organization_id, frequency_ms, signal, target_records)
VALUES ('00000000-0000-0000-0000-000000000000', -1, 'logs', 40000)
ON CONFLICT (organization_id, frequency_ms, signal) DO UPDATE
SET target_records = EXCLUDED.target_records,
    updated_at = now();

INSERT INTO metric_pack_estimate (organization_id, frequency_ms, signal, target_records)
VALUES ('00000000-0000-0000-0000-000000000000', -1, 'traces', 40000)
ON CONFLICT (organization_id, frequency_ms, signal) DO UPDATE
SET target_records = EXCLUDED.target_records,
    updated_at = now();

ALTER TABLE metric_pack_estimate RENAME TO pack_estimate;

ALTER INDEX idx_mpe_freq_signal_global RENAME TO idx_pe_freq_signal_global;
