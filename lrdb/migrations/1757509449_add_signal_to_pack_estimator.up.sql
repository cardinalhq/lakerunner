-- 1757509449_add_signal_to_pack_estimator.up.sql

-- Code generated by database migration. DO NOT EDIT.

-- Add signal column to metric_pack_estimate table to support logs and traces estimation
-- Step 1: Add signal column with default 'metrics'
ALTER TABLE metric_pack_estimate ADD COLUMN signal TEXT NOT NULL DEFAULT 'metrics';

-- Step 2: Drop existing primary key
ALTER TABLE metric_pack_estimate DROP CONSTRAINT metric_pack_estimate_pkey;

-- Step 3: Create new primary key including signal
ALTER TABLE metric_pack_estimate ADD PRIMARY KEY (signal, organization_id, frequency_ms);

-- Step 4: Drop and recreate the index with signal
DROP INDEX IF EXISTS idx_mpe_freq_global;
CREATE INDEX IF NOT EXISTS idx_mpe_freq_signal_global
  ON metric_pack_estimate (frequency_ms, signal)
  WHERE organization_id = '00000000-0000-0000-0000-000000000000'::uuid;

-- Step 5: Insert default estimates for logs (frequency_ms = -1)
INSERT INTO metric_pack_estimate (organization_id, frequency_ms, signal, target_records)
VALUES ('00000000-0000-0000-0000-000000000000', -1, 'logs', 40000)
ON CONFLICT (organization_id, frequency_ms, signal) DO UPDATE
SET target_records = EXCLUDED.target_records,
    updated_at = now();

-- Step 6: Insert default estimates for traces (frequency_ms = -1)
INSERT INTO metric_pack_estimate (organization_id, frequency_ms, signal, target_records)
VALUES ('00000000-0000-0000-0000-000000000000', -1, 'traces', 40000)
ON CONFLICT (organization_id, frequency_ms, signal) DO UPDATE
SET target_records = EXCLUDED.target_records,
    updated_at = now();

-- Step 7: Rename table to pack_estimate for cleaner naming
ALTER TABLE metric_pack_estimate RENAME TO pack_estimate;

-- Step 8: Rename the index to match the new table name
ALTER INDEX idx_mpe_freq_signal_global RENAME TO idx_pe_freq_signal_global;
