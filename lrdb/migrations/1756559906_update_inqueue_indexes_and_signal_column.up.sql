-- 1756559906_update_inqueue_indexes_and_signal_column.up.sql

-- Code generated by database migration. DO NOT EDIT.

-- Drop old index
DROP INDEX IF EXISTS idx_inqueue_pri_ts;

-- Rename telemetry_type column to signal and add check constraint
ALTER TABLE inqueue RENAME COLUMN telemetry_type TO signal;
ALTER TABLE inqueue ADD CONSTRAINT chk_inqueue_signal CHECK (signal IN ('logs', 'metrics', 'traces'));

-- Per-group ordered slice (lets DISTINCT ON and packing ride the index)
CREATE INDEX IF NOT EXISTS idx_inqueue_ready_group
ON inqueue (signal, organization_id, instance_num, priority DESC, queue_ts, id)
WHERE claimed_at IS NULL;

-- accelerator for big-single safety net
CREATE INDEX IF NOT EXISTS idx_inqueue_ready_bigfile
ON inqueue (signal, file_size DESC, priority DESC, queue_ts, id)
WHERE claimed_at IS NULL;
