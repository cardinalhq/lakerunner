// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: bucket_management.sql

package configdb

import (
	"context"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const checkOrgBucketAccess = `-- name: CheckOrgBucketAccess :one
SELECT COUNT(*) > 0 as has_access
FROM lrconfig_organization_buckets ob
JOIN lrconfig_bucket_configurations bc ON ob.bucket_id = bc.id
WHERE ob.organization_id = $1 AND bc.bucket_name = $2
`

type CheckOrgBucketAccessParams struct {
	OrgID      uuid.UUID `json:"org_id"`
	BucketName string    `json:"bucket_name"`
}

func (q *Queries) CheckOrgBucketAccess(ctx context.Context, arg CheckOrgBucketAccessParams) (bool, error) {
	row := q.db.QueryRow(ctx, checkOrgBucketAccess, arg.OrgID, arg.BucketName)
	var has_access bool
	err := row.Scan(&has_access)
	return has_access, err
}

const clearBucketConfigurations = `-- name: ClearBucketConfigurations :exec
DELETE FROM lrconfig_bucket_configurations
`

func (q *Queries) ClearBucketConfigurations(ctx context.Context) error {
	_, err := q.db.Exec(ctx, clearBucketConfigurations)
	return err
}

const clearBucketPrefixMappings = `-- name: ClearBucketPrefixMappings :exec
DELETE FROM lrconfig_bucket_prefix_mappings
`

func (q *Queries) ClearBucketPrefixMappings(ctx context.Context) error {
	_, err := q.db.Exec(ctx, clearBucketPrefixMappings)
	return err
}

const clearOrganizationBuckets = `-- name: ClearOrganizationBuckets :exec
DELETE FROM lrconfig_organization_buckets
`

func (q *Queries) ClearOrganizationBuckets(ctx context.Context) error {
	_, err := q.db.Exec(ctx, clearOrganizationBuckets)
	return err
}

const createBucketConfiguration = `-- name: CreateBucketConfiguration :one
INSERT INTO lrconfig_bucket_configurations (
  bucket_name, cloud_provider, region, endpoint, role
) VALUES (
  $1, $2, $3, $4, $5
) RETURNING id, bucket_name, cloud_provider, region, endpoint, role
`

type CreateBucketConfigurationParams struct {
	BucketName    string  `json:"bucket_name"`
	CloudProvider string  `json:"cloud_provider"`
	Region        string  `json:"region"`
	Endpoint      *string `json:"endpoint"`
	Role          *string `json:"role"`
}

func (q *Queries) CreateBucketConfiguration(ctx context.Context, arg CreateBucketConfigurationParams) (LrconfigBucketConfiguration, error) {
	row := q.db.QueryRow(ctx, createBucketConfiguration,
		arg.BucketName,
		arg.CloudProvider,
		arg.Region,
		arg.Endpoint,
		arg.Role,
	)
	var i LrconfigBucketConfiguration
	err := row.Scan(
		&i.ID,
		&i.BucketName,
		&i.CloudProvider,
		&i.Region,
		&i.Endpoint,
		&i.Role,
	)
	return i, err
}

const createBucketPrefixMapping = `-- name: CreateBucketPrefixMapping :one
INSERT INTO lrconfig_bucket_prefix_mappings (
  bucket_id, organization_id, path_prefix, signal
) VALUES (
  $1, $2, $3, $4
) RETURNING id, bucket_id, organization_id, path_prefix, signal
`

type CreateBucketPrefixMappingParams struct {
	BucketID       uuid.UUID `json:"bucket_id"`
	OrganizationID uuid.UUID `json:"organization_id"`
	PathPrefix     string    `json:"path_prefix"`
	Signal         string    `json:"signal"`
}

func (q *Queries) CreateBucketPrefixMapping(ctx context.Context, arg CreateBucketPrefixMappingParams) (LrconfigBucketPrefixMapping, error) {
	row := q.db.QueryRow(ctx, createBucketPrefixMapping,
		arg.BucketID,
		arg.OrganizationID,
		arg.PathPrefix,
		arg.Signal,
	)
	var i LrconfigBucketPrefixMapping
	err := row.Scan(
		&i.ID,
		&i.BucketID,
		&i.OrganizationID,
		&i.PathPrefix,
		&i.Signal,
	)
	return i, err
}

const createOrganizationBucket = `-- name: CreateOrganizationBucket :one
INSERT INTO lrconfig_organization_buckets (
  organization_id, bucket_id
) VALUES (
  $1, $2
) RETURNING id, organization_id, bucket_id
`

type CreateOrganizationBucketParams struct {
	OrganizationID uuid.UUID `json:"organization_id"`
	BucketID       uuid.UUID `json:"bucket_id"`
}

func (q *Queries) CreateOrganizationBucket(ctx context.Context, arg CreateOrganizationBucketParams) (LrconfigOrganizationBucket, error) {
	row := q.db.QueryRow(ctx, createOrganizationBucket, arg.OrganizationID, arg.BucketID)
	var i LrconfigOrganizationBucket
	err := row.Scan(&i.ID, &i.OrganizationID, &i.BucketID)
	return i, err
}

const getAllCStorageProfilesForSync = `-- name: GetAllCStorageProfilesForSync :many

SELECT DISTINCT
  sp.bucket AS bucket_name,
  sp.cloud_provider,
  sp.region,
  sp.role,
  c.organization_id
FROM c_storage_profiles sp
LEFT OUTER JOIN c_collectors c ON c.storage_profile_id = sp.id
WHERE c.deleted_at IS NULL
`

type GetAllCStorageProfilesForSyncRow struct {
	BucketName     string      `json:"bucket_name"`
	CloudProvider  string      `json:"cloud_provider"`
	Region         string      `json:"region"`
	Role           *string     `json:"role"`
	OrganizationID pgtype.UUID `json:"organization_id"`
}

// Legacy table sync operations
func (q *Queries) GetAllCStorageProfilesForSync(ctx context.Context) ([]GetAllCStorageProfilesForSyncRow, error) {
	rows, err := q.db.Query(ctx, getAllCStorageProfilesForSync)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetAllCStorageProfilesForSyncRow
	for rows.Next() {
		var i GetAllCStorageProfilesForSyncRow
		if err := rows.Scan(
			&i.BucketName,
			&i.CloudProvider,
			&i.Region,
			&i.Role,
			&i.OrganizationID,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getBucketByOrganization = `-- name: GetBucketByOrganization :one
SELECT bc.bucket_name
FROM lrconfig_organization_buckets ob
JOIN lrconfig_bucket_configurations bc ON ob.bucket_id = bc.id
WHERE ob.organization_id = $1
`

func (q *Queries) GetBucketByOrganization(ctx context.Context, organizationID uuid.UUID) (string, error) {
	row := q.db.QueryRow(ctx, getBucketByOrganization, organizationID)
	var bucket_name string
	err := row.Scan(&bucket_name)
	return bucket_name, err
}

const getBucketConfiguration = `-- name: GetBucketConfiguration :one
SELECT id, bucket_name, cloud_provider, region, endpoint, role FROM lrconfig_bucket_configurations WHERE bucket_name = $1
`

func (q *Queries) GetBucketConfiguration(ctx context.Context, bucketName string) (LrconfigBucketConfiguration, error) {
	row := q.db.QueryRow(ctx, getBucketConfiguration, bucketName)
	var i LrconfigBucketConfiguration
	err := row.Scan(
		&i.ID,
		&i.BucketName,
		&i.CloudProvider,
		&i.Region,
		&i.Endpoint,
		&i.Role,
	)
	return i, err
}

const getLongestPrefixMatch = `-- name: GetLongestPrefixMatch :one
SELECT bpm.organization_id
FROM lrconfig_bucket_prefix_mappings bpm
JOIN lrconfig_bucket_configurations bc ON bpm.bucket_id = bc.id
WHERE bc.bucket_name = $1 
  AND bpm.signal = $2
  AND $3 LIKE bpm.path_prefix || '%'
ORDER BY LENGTH(bpm.path_prefix) DESC
LIMIT 1
`

type GetLongestPrefixMatchParams struct {
	BucketName string `json:"bucket_name"`
	Signal     string `json:"signal"`
	ObjectPath string `json:"object_path"`
}

func (q *Queries) GetLongestPrefixMatch(ctx context.Context, arg GetLongestPrefixMatchParams) (uuid.UUID, error) {
	row := q.db.QueryRow(ctx, getLongestPrefixMatch, arg.BucketName, arg.Signal, arg.ObjectPath)
	var organization_id uuid.UUID
	err := row.Scan(&organization_id)
	return organization_id, err
}

const getOrganizationsByBucket = `-- name: GetOrganizationsByBucket :many
SELECT ob.organization_id 
FROM lrconfig_organization_buckets ob
JOIN lrconfig_bucket_configurations bc ON ob.bucket_id = bc.id
WHERE bc.bucket_name = $1
`

func (q *Queries) GetOrganizationsByBucket(ctx context.Context, bucketName string) ([]uuid.UUID, error) {
	rows, err := q.db.Query(ctx, getOrganizationsByBucket, bucketName)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []uuid.UUID
	for rows.Next() {
		var organization_id uuid.UUID
		if err := rows.Scan(&organization_id); err != nil {
			return nil, err
		}
		items = append(items, organization_id)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const upsertBucketConfiguration = `-- name: UpsertBucketConfiguration :one
INSERT INTO lrconfig_bucket_configurations (
  bucket_name, cloud_provider, region, endpoint, role
) VALUES (
  $1, $2, $3, $4, $5
) ON CONFLICT (bucket_name) DO UPDATE SET
  cloud_provider = EXCLUDED.cloud_provider,
  region = EXCLUDED.region,
  endpoint = EXCLUDED.endpoint,
  role = EXCLUDED.role
RETURNING id, bucket_name, cloud_provider, region, endpoint, role
`

type UpsertBucketConfigurationParams struct {
	BucketName    string  `json:"bucket_name"`
	CloudProvider string  `json:"cloud_provider"`
	Region        string  `json:"region"`
	Endpoint      *string `json:"endpoint"`
	Role          *string `json:"role"`
}

func (q *Queries) UpsertBucketConfiguration(ctx context.Context, arg UpsertBucketConfigurationParams) (LrconfigBucketConfiguration, error) {
	row := q.db.QueryRow(ctx, upsertBucketConfiguration,
		arg.BucketName,
		arg.CloudProvider,
		arg.Region,
		arg.Endpoint,
		arg.Role,
	)
	var i LrconfigBucketConfiguration
	err := row.Scan(
		&i.ID,
		&i.BucketName,
		&i.CloudProvider,
		&i.Region,
		&i.Endpoint,
		&i.Role,
	)
	return i, err
}

const upsertOrganizationBucket = `-- name: UpsertOrganizationBucket :exec
INSERT INTO lrconfig_organization_buckets (
  organization_id, bucket_id
) VALUES (
  $1, $2
) ON CONFLICT (organization_id) DO UPDATE SET
  bucket_id = EXCLUDED.bucket_id
`

type UpsertOrganizationBucketParams struct {
	OrganizationID uuid.UUID `json:"organization_id"`
	BucketID       uuid.UUID `json:"bucket_id"`
}

func (q *Queries) UpsertOrganizationBucket(ctx context.Context, arg UpsertOrganizationBucketParams) error {
	_, err := q.db.Exec(ctx, upsertOrganizationBucket, arg.OrganizationID, arg.BucketID)
	return err
}
