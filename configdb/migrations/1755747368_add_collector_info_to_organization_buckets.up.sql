-- 1755747368_add_collector_info_to_organization_buckets.up.sql

-- Code generated by database migration. DO NOT EDIT.

-- Add collector information to organization_buckets table to support 
-- the collector name in S3 paths: db/organization_uuid/collector_name/.../tbl_123_123.parquet

-- Add instance_num and collector_name fields
ALTER TABLE organization_buckets 
ADD COLUMN instance_num SMALLINT,
ADD COLUMN collector_name TEXT;

-- Update existing records to have instance_num = 1 and a default collector name
UPDATE organization_buckets 
SET instance_num = 1, collector_name = 'default' 
WHERE instance_num IS NULL;

-- Make the new fields NOT NULL after populating them
ALTER TABLE organization_buckets 
ALTER COLUMN instance_num SET NOT NULL,
ALTER COLUMN collector_name SET NOT NULL;

-- Add indexes for the new fields
CREATE INDEX idx_org_buckets_org_instance ON organization_buckets(organization_id, instance_num);
CREATE INDEX idx_org_buckets_collector ON organization_buckets(collector_name);